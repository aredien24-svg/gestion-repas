<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Repas des Compagnons</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .view-hidden { display: none; }
        .calendar-table { border-collapse: collapse; width: 100%; }
        .calendar-table th, .calendar-table td {
            border: 1px solid #e5e7eb;
            padding: 8px;
            text-align: left;
            vertical-align: top;
            height: 140px; /* Increased height for menu */
        }
        .calendar-table th { text-align: center; background-color: #f9fafb; }
        .calendar-day-number { font-weight: bold; font-size: 1.1rem; }
        .other-month { background-color: #f9fafb; color: #d1d5db; }
        .meal-choice-btn.selected { background-color: #1e40af; color: white; font-weight: bold; }
        .admin-tab.active { border-bottom: 2px solid #ea580c; color: #1e3a8a; }
        .modal-overlay {
            position: fixed;
            z-index: 50;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- En-tête -->
        <header class="bg-white shadow-md rounded-lg p-4 mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-4">
                    <img src="https://www.compagnons-du-devoir.com/sites/default/files/logo_cddt_0.png" alt="Logo Compagnons du Devoir" class="h-16">
                    <div class="text-center md:text-left">
                        <h1 class="text-3xl font-bold text-blue-800">Gestion des Repas</h1>
                        <p class="text-gray-500 mt-1">Application de la Maison de La Rochelle</p>
                    </div>
                </div>
                <div id="header-controls" class="flex items-center space-x-4 mt-4 md:mt-0 view-hidden">
                     <span id="user-id-display" class="text-sm text-gray-500 bg-gray-200 px-3 py-1 rounded-full"></span>
                     <button id="logout-btn" class="px-4 py-2 text-sm font-medium bg-orange-500 text-white rounded-md hover:bg-orange-600 focus:outline-none">Déconnexion</button>
                </div>
            </div>
        </header>

        <!-- Vue de Connexion -->
        <main id="login-view">
             <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-center text-blue-800 mb-6">Identifiez-vous</h2>
                <div class="space-y-4">
                    <div>
                        <label for="user-select" class="block text-sm font-medium text-gray-700">Choisissez votre profil</label>
                        <select id="user-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md">
                            <option>Chargement...</option>
                        </select>
                    </div>
                    <button id="login-user-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-800 hover:bg-blue-900">
                        Accéder à mon calendrier
                    </button>
                </div>
                <div class="mt-6 border-t pt-4">
                     <label for="admin-password" class="block text-sm font-medium text-gray-700">Accès Administrateur</label>
                     <input type="password" id="admin-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Mot de passe">
                     <button id="login-admin-btn" class="mt-2 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700">
                        Connexion Admin
                    </button>
                    <p id="admin-error" class="text-red-500 text-xs mt-1"></p>
                </div>
             </div>
        </main>

        <!-- Vue Itinérant -->
        <main id="itinerant-view" class="view-hidden">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div id="calendar-header" class="flex justify-between items-center text-center mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
                    <h2 class="text-2xl font-semibold"></h2>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
                </div>
                <div id="calendar-container" class="overflow-x-auto"></div>
            </div>
        </main>

        <!-- Vue Administrateur -->
        <main id="admin-view" class="view-hidden">
            <div class="mb-4 border-b border-gray-200">
                <nav id="admin-tabs" class="flex space-x-8" aria-label="Tabs">
                    <button class="admin-tab active" data-tab="reports">Rapports & Décomptes</button>
                    <button class="admin-tab" data-tab="users">Gestion Utilisateurs</button>
                    <button class="admin-tab" data-tab="menus">Gestion Menus</button>
                </nav>
            </div>

            <div id="admin-tab-content">
                <!-- Rapports -->
                <div id="tab-reports">
                     <div class="flex justify-between items-center text-center mb-4 bg-white p-4 rounded-lg shadow">
                         <button id="admin-prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
                         <h3 class="text-xl font-semibold" id="admin-header-daily">Décompte journalier</h3>
                         <button id="admin-next-month-btn" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
                     </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-lg shadow-md"><div id="admin-counts-container"></div></div>
                        <div class="bg-white p-6 rounded-lg shadow-md">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-semibold">Décompte par Itinérant</h3>
                                <button id="export-csv-btn" class="px-4 py-2 text-sm font-medium bg-green-600 text-white rounded-md hover:bg-green-700">Exporter (CSV)</button>
                            </div>
                            <div id="admin-user-counts-container" class="max-h-96 overflow-y-auto"></div>
                        </div>
                    </div>
                </div>

                <!-- Gestion Utilisateurs -->
                <div id="tab-users" class="view-hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Créer un utilisateur</h3>
                            <form id="create-user-form" class="space-y-4">
                                <input type="text" id="user-nom" placeholder="Nom" required class="w-full p-2 border rounded">
                                <input type="text" id="user-prenom" placeholder="Prénom" required class="w-full p-2 border rounded">
                                <input type="email" id="user-email" placeholder="Email" required class="w-full p-2 border rounded">
                                <input type="text" id="user-chambre" placeholder="N° de chambre" required class="w-full p-2 border rounded">
                                <select id="user-metier" required class="w-full p-2 border rounded">
                                    <option value="" disabled selected>Choisir un métier</option>
                                    <option>Menuisier</option><option>Charpentier</option><option>Maçon</option><option>Plombier</option>
                                    <option>Serrurier-Métallier</option><option>Peintre</option><option>Boulanger</option><option>Pâtissier</option>
                                </select>
                                <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-blue-800 hover:bg-blue-900">Créer</button>
                                <p id="user-create-feedback" class="text-green-600 text-sm"></p>
                            </form>
                        </div>
                        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                            <h3 class="text-xl font-semibold mb-4">Liste des utilisateurs</h3>
                            <div id="user-list-container" class="max-h-[30rem] overflow-y-auto transition-opacity duration-300"></div>
                        </div>
                     </div>
                </div>

                <!-- Gestion Menus -->
                <div id="tab-menus" class="view-hidden">
                    <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-2xl font-semibold mb-4">Ajouter / Modifier un menu</h2>
                        <form id="meal-form" class="space-y-4">
                            <div>
                                <label for="day" class="block text-sm font-medium text-gray-700">Jour de la semaine</label>
                                <select id="day" name="day" class="mt-1 block w-full p-2 border-gray-300 rounded-md">
                                    <option>Lundi</option> <option>Mardi</option> <option>Mercredi</option> <option>Jeudi</option> <option>Vendredi</option> <option>Samedi</option> <option>Dimanche</option>
                                </select>
                            </div>
                            <div>
                                <label for="meal-type" class="block text-sm font-medium text-gray-700">Type de repas</label>
                                <select id="meal-type" name="meal-type" class="mt-1 block w-full p-2 border-gray-300 rounded-md">
                                    <option>Déjeuner</option>
                                    <option>Dîner</option>
                                </select>
                            </div>
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700">Description du repas</label>
                                <textarea id="description" name="description" rows="4" class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Poulet rôti, frites..."></textarea>
                            </div>
                            <button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-blue-800 hover:bg-blue-900">
                                Enregistrer le menu
                            </button>
                             <div id="save-feedback" class="text-center text-green-600 font-medium mt-2"></div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modale d'édition d'utilisateur -->
    <div id="edit-user-modal" class="modal-overlay view-hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md">
            <h2 class="text-2xl font-bold mb-4">Modifier l'utilisateur</h2>
            <form id="edit-user-form" class="space-y-4">
                <input type="hidden" id="edit-user-id">
                <input type="text" id="edit-user-nom" placeholder="Nom" required class="w-full p-2 border rounded">
                <input type="text" id="edit-user-prenom" placeholder="Prénom" required class="w-full p-2 border rounded">
                <input type="email" id="edit-user-email" placeholder="Email" required class="w-full p-2 border rounded">
                <input type="text" id="edit-user-chambre" placeholder="N° de chambre" required class="w-full p-2 border rounded">
                <select id="edit-user-metier" required class="w-full p-2 border rounded">
                     <option>Menuisier</option><option>Charpentier</option><option>Maçon</option><option>Plombier</option>
                     <option>Serrurier-Métallier</option><option>Peintre</option><option>Boulanger</option><option>Pâtissier</option>
                </select>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="cancel-edit-btn" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Annuler</button>
                    <button type="submit" class="px-4 py-2 rounded-md text-white bg-blue-800 hover:bg-blue-900">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modale de Confirmation de Suppression -->
    <div id="delete-confirm-modal" class="modal-overlay view-hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Confirmer la suppression</h2>
            <p id="delete-confirm-text" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancel-delete-btn" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300">Annuler</button>
                <button type="button" id="confirm-delete-btn" class="px-4 py-2 rounded-md text-white bg-red-600 hover:bg-red-700">Supprimer</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, where, getDocs, addDoc, serverTimestamp, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBQrYxzDJiSaX6fAzFCHRsMjOmznXQ1KSo",
            authDomain: "gestion-repas-compagnons.firebaseapp.com",
            projectId: "gestion-repas-compagnons",
            storageBucket: "gestion-repas-compagnons.appspot.com",
            messagingSenderId: "74457969505",
            appId: "1:74457969505:web:edc6bbb1a0332ca9ddcb20",
            measurementId: "G-4KYNTJNL3T"
        };
        
        const appId = firebaseConfig.projectId; // Use projectId as a unique identifier
        const ADMIN_PASSWORD = "admin";

        // --- Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentUserId = null;
        let selectedUserProfile = null;
        let allUsers = [];
        let allSchedules = [];
        let allMenus = {};
        const daysOfWeek = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
        let currentDate = new Date();
        let unsubscribeUsersLoginListener = null; 
        let userIdToDelete = null; 

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const itinerantView = document.getElementById('itinerant-view');
        const adminView = document.getElementById('admin-view');
        const headerControls = document.getElementById('header-controls');
        const userSelect = document.getElementById('user-select');
        const calendarContainer = document.getElementById('calendar-container');
        const calendarHeader = document.getElementById('calendar-header').querySelector('h2');
        const adminHeaderDaily = document.getElementById('admin-header-daily');
        const userListContainer = document.getElementById('user-list-container');
        const editUserModal = document.getElementById('edit-user-modal');
        const editUserForm = document.getElementById('edit-user-form');
        const adminCountsContainer = document.getElementById('admin-counts-container');
        const adminUserCountsContainer = document.getElementById('admin-user-counts-container');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        
        // --- Collections Refs ---
        const getUsersCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'users');
        const getSchedulesCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'schedules');
        const getMenusCollection = () => collection(db, 'artifacts', appId, 'public', 'data', 'menus');
        
        // --- Modal Management (Definitive Fix) ---
        const showModal = (modalToShow) => {
            const modals = [editUserModal, deleteConfirmModal];
            modals.forEach(modal => modal.classList.add('view-hidden'));

            if (modalToShow) {
                modalToShow.classList.remove('view-hidden');
                userListContainer.classList.add('opacity-50', 'pointer-events-none');
            } else {
                userListContainer.classList.remove('opacity-50', 'pointer-events-none');
            }
        };

        // --- Date Management ---
        const getMonthData = (year, month) => {
            const monthName = new Date(year, month).toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIndex = (new Date(year, month, 1).getDay() + 6) % 7;
            return { monthName, daysInMonth, firstDayIndex };
        };

        const updateCurrentDate = (monthOffset) => {
            currentDate.setDate(1); 
            currentDate.setMonth(currentDate.getMonth() + monthOffset);
            if (selectedUserProfile) initializeItinerantView();
            if (adminView.classList.contains('view-hidden') === false) initializeAdminView();
        };

        // --- App Initialization ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                
                if (unsubscribeUsersLoginListener) unsubscribeUsersLoginListener();
                
                unsubscribeUsersLoginListener = onSnapshot(query(getUsersCollection()), (snapshot) => {
                    allUsers = [];
                    snapshot.forEach(doc => allUsers.push({ id: doc.id, ...doc.data() }));
                    userSelect.innerHTML = '<option value="">-- Sélectionnez votre nom --</option>';
                    
                    if (snapshot.empty) {
                         const option = document.createElement('option');
                         option.textContent = "Aucun utilisateur créé";
                         option.disabled = true;
                         userSelect.appendChild(option);
                    } else {
                        allUsers.sort((a,b) => a.nom.localeCompare(b.nom)).forEach(user => {
                            const option = document.createElement('option');
                            option.value = user.id;
                            option.textContent = `${user.prenom} ${user.nom}`;
                            userSelect.appendChild(option);
                        });
                    }
                }, (error) => {
                    console.error("Firestore error on users collection:", error);
                    userSelect.innerHTML = '<option>Erreur de chargement</option>';
                });

                listenToMenus();
                
                if (!selectedUserProfile) {
                    showView('login');
                }
            } else {
                signInAnonymously(auth).catch(err => {
                    console.error("Anonymous sign-in failed:", err);
                    if (err.code === 'auth/configuration-not-found') {
                        const loginView = document.getElementById('login-view');
                        loginView.innerHTML = `
                             <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md text-center">
                                <h2 class="text-2xl font-bold text-red-600 mb-4">Erreur de Configuration Firebase</h2>
                                <p class="text-gray-700">La méthode de connexion "Anonyme" doit être activée.</p>
                                <p class="mt-4 text-gray-600 text-sm">Pour corriger cela :</p>
                                <ol class="text-left text-sm mt-2 list-decimal list-inside space-y-1 bg-gray-50 p-4 rounded-md">
                                    <li>Allez sur la <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 hover:underline">Console Firebase</a>.</li>
                                    <li>Sélectionnez votre projet (<strong>${firebaseConfig.projectId}</strong>).</li>
                                    <li>Dans le menu de gauche, allez à <strong>Build > Authentication</strong>.</li>
                                    <li>Cliquez sur l'onglet <strong>Fournisseurs de connexion</strong> (ou Sign-in method).</li>
                                    <li>Dans la liste, trouvez <strong>Anonyme</strong>, cliquez dessus et activez-le.</li>
                                    <li>Rechargez cette page.</li>
                                </ol>
                            </div>
                        `;
                    }
                });
            }
        });

        const listenToMenus = () => {
             onSnapshot(query(getMenusCollection()), (snapshot) => {
                allMenus = {};
                snapshot.forEach(doc => { allMenus[doc.id] = doc.data(); });
                if (selectedUserProfile) initializeItinerantView();
             });
        };
        
        const showView = (viewName) => {
            loginView.classList.add('view-hidden');
            itinerantView.classList.add('view-hidden');
            adminView.classList.add('view-hidden');
            headerControls.classList.add('view-hidden');

            if (viewName === 'login') {
                loginView.classList.remove('view-hidden');
            } else if (viewName === 'itinerant') {
                itinerantView.classList.remove('view-hidden');
                headerControls.classList.remove('view-hidden');
            } else if (viewName === 'admin') {
                adminView.classList.remove('view-hidden');
                headerControls.classList.remove('view-hidden');
            }
        };

        const logout = () => {
            selectedUserProfile = null;
            currentDate = new Date(); 
            document.getElementById('user-id-display').textContent = '';
            showView('login');
        };

        // --- Itinerant Logic ---
        const initializeItinerantView = () => {
            if (!selectedUserProfile) return;
            document.getElementById('user-id-display').textContent = `Profil: ${selectedUserProfile.prenom}`;
            
            const targetYear = currentDate.getFullYear();
            const targetMonth = currentDate.getMonth();
            const scheduleDocId = `${selectedUserProfile.id}-${targetYear}-${targetMonth}`;
            
            onSnapshot(doc(getSchedulesCollection(), scheduleDocId), (doc) => {
                const userSchedule = doc.exists() ? doc.data() : {};
                renderItinerantCalendar(userSchedule);
            });
        };

        const renderItinerantCalendar = (schedule = {}) => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const { monthName, daysInMonth, firstDayIndex } = getMonthData(year, month);
            calendarHeader.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

            let html = `<table class="calendar-table"><thead><tr>`;
            daysOfWeek.forEach(day => html += `<th>${day.substring(0,3)}</th>`);
            html += `</tr></thead><tbody><tr>`;
            for (let i = 0; i < firstDayIndex; i++) { html += `<td class="other-month"></td>`; }

            for (let day = 1; day <= daysInMonth; day++) {
                if (day > 1 && (firstDayIndex + day - 1) % 7 === 0) { html += `</tr><tr>`; }
                
                const dayDate = new Date(year, month, day);
                const dayOfWeekName = daysOfWeek[dayDate.getDay() === 0 ? 6 : dayDate.getDay() - 1];

                const menuDejeuner = allMenus[`${dayOfWeekName}-Déjeuner`]?.description || '<i>Non défini</i>';
                const menuDiner = allMenus[`${dayOfWeekName}-Dîner`]?.description || '<i>Non défini</i>';

                const daySchedule = schedule[day] || {};
                const midiStatus = daySchedule.midi || '-';
                const soirStatus = daySchedule.soir || '-';

                html += `<td>
                    <div class="calendar-day-number">${day}</div>
                    <div class="text-xs text-gray-500 mt-1 space-y-1">
                        <p><b>M:</b> ${menuDejeuner}</p>
                        <p><b>S:</b> ${menuDiner}</p>
                    </div>
                    <div class="mt-2 space-y-1 text-xs">
                         <div class="flex items-center"><span class="w-10">Midi:</span><button data-day="${day}" data-meal="midi" data-status="1" class="meal-choice-btn p-1 border rounded ${midiStatus === '1' || midiStatus === 'S' ? 'selected' : ''}">1</button><button data-day="${day}" data-meal="midi" data-status="0" class="meal-choice-btn p-1 border rounded ml-1 ${midiStatus === '0' || midiStatus === 'V' ? 'selected' : ''}">0</button></div>
                         <div class="flex items-center"><span class="w-10">Soir:</span><button data-day="${day}" data-meal="soir" data-status="1" class="meal-choice-btn p-1 border rounded ${soirStatus === '1' || soirStatus === 'S' ? 'selected' : ''}">1</button><button data-day="${day}" data-meal="soir" data-status="0" class="meal-choice-btn p-1 border rounded ml-1 ${soirStatus === '0' || soirStatus === 'V' ? 'selected' : ''}">0</button></div>
                         <div class="border-t pt-1 mt-1 flex space-x-1"><button data-day="${day}" data-type="stage" class="day-action-btn flex-1 p-1 border rounded bg-blue-100 hover:bg-blue-200">Stage</button><button data-day="${day}" data-type="vacances" class="day-action-btn flex-1 p-1 border rounded bg-yellow-100 hover:bg-yellow-200">Vacance</button></div>
                    </div>
                </td>`;
            }
            html += `</tr></tbody></table>`;
            calendarContainer.innerHTML = html;
        };

        // --- Admin Logic ---
        const initializeAdminView = () => {
            document.getElementById('user-id-display').textContent = 'Mode Administrateur';
            const targetYear = currentDate.getFullYear();
            const targetMonth = currentDate.getMonth();
            const schedulesQuery = query(getSchedulesCollection(), where("month", "==", targetMonth), where("year", "==", targetYear));
            
            onSnapshot(schedulesQuery, (snapshot) => {
                 allSchedules = [];
                 snapshot.forEach(doc => allSchedules.push({ id: doc.id, ...doc.data() }));
                 renderAdminReports();
            });

            onSnapshot(query(getUsersCollection()), (snapshot) => {
                allUsers = [];
                snapshot.forEach(doc => allUsers.push({ id: doc.id, ...doc.data() }));
                renderUserList();
                renderAdminReports();
            });
        };

        const renderAdminReports = () => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const { monthName, daysInMonth } = getMonthData(year, month);
            adminHeaderDaily.textContent = `Décompte pour ${monthName}`;
            
            const dailyCounts = {};
            for(let day=1; day<=daysInMonth; day++) { dailyCounts[day] = { midi: 0, soir: 0 }; }

            allSchedules.forEach(schedule => {
                for(let day=1; day<=daysInMonth; day++) {
                    const daySchedule = schedule[day];
                    if (daySchedule) {
                        if (daySchedule.midi === '1' || daySchedule.midi === 'S') dailyCounts[day].midi++;
                        if (daySchedule.soir === '1' || daySchedule.soir === 'S') dailyCounts[day].soir++;
                    }
                }
            });

            let dailyHtml = `<table class="w-full text-sm"><thead><tr class="bg-gray-50"><th class="p-2 border">Jour</th><th class="p-2 border">Déjeuner</th><th class="p-2 border">Dîner</th></tr></thead><tbody>`;
            for(let day=1; day<=daysInMonth; day++) {
                dailyHtml += `<tr><td class="p-2 border font-bold">${day}</td><td class="p-2 border text-center text-blue-800 font-bold">${dailyCounts[day].midi}</td><td class="p-2 border text-center text-blue-800 font-bold">${dailyCounts[day].soir}</td></tr>`;
            }
            dailyHtml += `</tbody></table>`;
            adminCountsContainer.innerHTML = dailyHtml;

            let userHtml = `<table class="w-full text-sm"><thead><tr class="bg-gray-50"><th class="p-2 border text-left">Nom</th><th class="p-2 border">Midi</th><th class="p-2 border">Soir</th></tr></thead><tbody>`;
            allUsers.sort((a,b) => a.nom.localeCompare(b.nom)).forEach(user => {
                const userSchedule = allSchedules.find(s => s.userId === user.id);
                let midiCount = 0;
                let soirCount = 0;
                if(userSchedule) {
                    for(let day=1; day<=daysInMonth; day++) {
                        const daySchedule = userSchedule[day];
                        if (daySchedule) {
                            if (daySchedule.midi === '1' || daySchedule.midi === 'S') midiCount++;
                            if (daySchedule.soir === '1' || daySchedule.soir === 'S') soirCount++;
                        }
                    }
                }
                userHtml += `<tr><td class="p-2 border">${user.prenom} ${user.nom}</td><td class="p-2 border text-center font-bold">${midiCount}</td><td class="p-2 border text-center font-bold">${soirCount}</td></tr>`;
            });
            userHtml += `</tbody></table>`;
            adminUserCountsContainer.innerHTML = userHtml;
        };

        const renderUserList = () => {
             let html = `<table class="w-full text-sm"><thead><tr class="bg-gray-50">
                <th class="p-2 border text-left">Nom</th><th class="p-2 border text-left">Métier</th><th class="p-2 border">Actions</th>
             </tr></thead><tbody>`;
             allUsers.sort((a,b) => a.nom.localeCompare(b.nom)).forEach(user => {
                 html += `<tr>
                    <td class="p-2 border">${user.prenom} ${user.nom}</td>
                    <td class="p-2 border">${user.metier}</td>
                    <td class="p-2 border text-center">
                        <button data-id="${user.id}" class="edit-user-btn text-blue-600 hover:text-blue-800">Modifier</button>
                        <button data-id="${user.id}" data-name="${user.prenom} ${user.nom}" class="delete-user-btn text-red-600 hover:text-red-800 ml-2">Suppr.</button>
                    </td>
                 </tr>`;
             });
             html += `</tbody></table>`;
             userListContainer.innerHTML = html;
        };
        
        const exportToCSV = () => {
             const year = currentDate.getFullYear();
             const month = currentDate.getMonth();
             const { daysInMonth } = getMonthData(year, month);
             let csvContent = "data:text/csv;charset=utf-8,";
             csvContent += "Prénom,Nom,Métier,Chambre,Total Midi,Total Soir\r\n";

            allUsers.forEach(user => {
                const userSchedule = allSchedules.find(s => s.userId === user.id);
                let midiCount = 0;
                let soirCount = 0;
                if(userSchedule) {
                     for(let day=1; day<=daysInMonth; day++) {
                        const daySchedule = userSchedule[day];
                        if(daySchedule) {
                            if (daySchedule.midi === '1' || daySchedule.midi === 'S') midiCount++;
                            if (daySchedule.soir === '1' || daySchedule.soir === 'S') soirCount++;
                        }
                    }
                }
                csvContent += `${user.prenom},${user.nom},${user.metier},${user.chambre},${midiCount},${soirCount}\r\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `decompte_repas_${year}_${month+1}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        // --- Event Listeners ---
        document.getElementById('login-user-btn').addEventListener('click', () => {
            const selectedId = userSelect.value;
            if (selectedId) {
                selectedUserProfile = allUsers.find(u => u.id === selectedId);
                if (selectedUserProfile) {
                    currentDate = new Date();
                    showView('itinerant');
                    initializeItinerantView();
                }
            }
        });
        document.getElementById('login-admin-btn').addEventListener('click', () => {
             if (document.getElementById('admin-password').value === ADMIN_PASSWORD) {
                document.getElementById('admin-error').textContent = '';
                document.getElementById('admin-password').value = '';
                currentDate = new Date();
                showView('admin');
                initializeAdminView();
            } else {
                document.getElementById('admin-error').textContent = 'Mot de passe incorrect.';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);

        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const newUser = {
                nom: form['user-nom'].value, prenom: form['user-prenom'].value,
                email: form['user-email'].value, chambre: form['user-chambre'].value,
                metier: form['user-metier'].value, createdAt: serverTimestamp()
            };
            try {
                await addDoc(getUsersCollection(), newUser);
                document.getElementById('user-create-feedback').textContent = 'Utilisateur créé !';
                form.reset();
                setTimeout(() => document.getElementById('user-create-feedback').textContent = '', 3000);
            } catch (err) { console.error(err); }
        });

        document.getElementById('prev-month-btn').addEventListener('click', () => updateCurrentDate(-1));
        document.getElementById('next-month-btn').addEventListener('click', () => updateCurrentDate(1));
        document.getElementById('admin-prev-month-btn').addEventListener('click', () => updateCurrentDate(-1));
        document.getElementById('admin-next-month-btn').addEventListener('click', () => updateCurrentDate(1));

        calendarContainer.addEventListener('click', async (e) => {
            const target = e.target;
            const day = target.dataset.day;
            if (!day || !selectedUserProfile) return;
            
            const targetYear = currentDate.getFullYear();
            const targetMonth = currentDate.getMonth();
            const scheduleDocRef = doc(getSchedulesCollection(), `${selectedUserProfile.id}-${targetYear}-${targetMonth}`);
            let currentDayValues = {};
            const scheduleDoc = await getDoc(scheduleDocRef).catch(() => null);
            if (scheduleDoc && scheduleDoc.exists() && scheduleDoc.data()[day]) {
                currentDayValues = scheduleDoc.data()[day];
            }

            const updateSchedule = (values) => {
                 setDoc(scheduleDocRef, { 
                    [day]: values,
                    userId: selectedUserProfile.id,
                    year: targetYear,
                    month: targetMonth
                 }, { merge: true }).catch(console.error);
            };

            if (target.classList.contains('meal-choice-btn')) {
                currentDayValues[target.dataset.meal] = target.dataset.status;
                updateSchedule(currentDayValues);
            }
            if (target.classList.contains('day-action-btn')) {
                updateSchedule({ midi: target.dataset.type === 'stage' ? 'S' : 'V', soir: target.dataset.type === 'stage' ? 'S' : 'V' });
            }
        });

        userListContainer.addEventListener('click', (e) => {
            const userId = e.target.dataset.id;
            if (!userId) return;

            if (e.target.classList.contains('edit-user-btn')) {
                const userToEdit = allUsers.find(u => u.id === userId);
                if (userToEdit) {
                    editUserForm['edit-user-id'].value = userToEdit.id;
                    editUserForm['edit-user-nom'].value = userToEdit.nom;
                    editUserForm['edit-user-prenom'].value = userToEdit.prenom;
                    editUserForm['edit-user-email'].value = userToEdit.email;
                    editUserForm['edit-user-chambre'].value = userToEdit.chambre;
                    editUserForm['edit-user-metier'].value = userToEdit.metier;
                    showModal(editUserModal);
                }
            } else if (e.target.classList.contains('delete-user-btn')) {
                const userName = e.target.dataset.name;
                userIdToDelete = userId;
                document.getElementById('delete-confirm-text').textContent = `Êtes-vous sûr de vouloir supprimer ${userName} ? Cette action est irréversible.`;
                showModal(deleteConfirmModal);
            }
        });
        
        document.getElementById('cancel-delete-btn').addEventListener('click', () => {
            showModal(null);
            userIdToDelete = null;
        });

        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (userIdToDelete) {
                deleteDoc(doc(getUsersCollection(), userIdToDelete)).catch(err => console.error("Error deleting user:", err));
            }
            showModal(null);
            userIdToDelete = null;
        });

        editUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = editUserForm['edit-user-id'].value;
            try {
                const updatedData = {
                    nom: editUserForm['edit-user-nom'].value, prenom: editUserForm['edit-user-prenom'].value,
                    email: editUserForm['edit-user-email'].value, chambre: editUserForm['edit-user-chambre'].value,
                    metier: editUserForm['edit-user-metier'].value,
                };
                await updateDoc(doc(getUsersCollection(), userId), updatedData);
            } catch (error) {
                console.error("Error updating user:", error);
            } finally {
                showModal(null);
            }
        });

        document.getElementById('cancel-edit-btn').addEventListener('click', () => {
            showModal(null);
        });

        document.getElementById('admin-tabs').addEventListener('click', (e) => {
            if (e.target.matches('.admin-tab')) {
                const tab = e.target.dataset.tab;
                document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                
                document.querySelectorAll('#admin-tab-content > div').forEach(c => c.classList.add('view-hidden'));
                document.getElementById(`tab-${tab}`).classList.remove('view-hidden');
            }
        });
        
        document.getElementById('meal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const mealId = `${form.day.value}-${form['meal-type'].value}`;
            try {
                await setDoc(doc(getMenusCollection(), mealId), { 
                    day: form.day.value, 
                    mealType: form['meal-type'].value, 
                    description: form.description.value 
                });
                document.getElementById('save-feedback').textContent = 'Menu enregistré !';
                form.description.value = '';
                setTimeout(() => document.getElementById('save-feedback').textContent = '', 2000);
            } catch (error) { console.error("Error saving meal: ", error); }
        });

    </script>
</body>
</html>

