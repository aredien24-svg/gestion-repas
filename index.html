<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Repas des Compagnons</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .view-hidden { display: none; }
        .calendar-table { border-collapse: collapse; width: 100%; }
        .calendar-table th, .calendar-table td {
            border: 1px solid #e5e7eb;
            text-align: left;
            vertical-align: top;
        }
        .calendar-table th { text-align: center; background-color: #f9fafb; }
        .calendar-day-number { font-weight: bold; font-size: 1.1rem; }
        .other-month { background-color: #f9fafb; color: #d1d5db; }
        .meal-choice-btn.selected { background-color: #1e40af; color: white; font-weight: bold; }
        .admin-tab.active { border-bottom: 2px solid #ea580c; color: #1e3a8a; }
        .day-locked { background-color: #f3f4f6; cursor: not-allowed; }
        .day-locked .meal-choice-btn { pointer-events: none; opacity: 0.6; }

    </style>
</head>
<body class="text-gray-800">

    <div class="container mx-auto p-2 sm:p-4 md:p-6 max-w-7xl">

        <!-- En-tête -->
        <header class="bg-white shadow-md rounded-lg p-4 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <img src="./logo.png" alt="Logo Compagnons du Devoir" class="h-12 sm:h-16" onerror="this.style.display='none'">
                    <div class="text-center md:text-left">
                        <h1 class="text-xl sm:text-3xl font-bold text-blue-800">Gestion des Repas</h1>
                        <p class="text-gray-500 mt-1 text-sm sm:text-base">Maison de La Rochelle</p>
                    </div>
                </div>
                <div id="header-controls" class="flex items-center space-x-2 sm:space-x-4 mt-4 md:mt-0 view-hidden">
                     <span id="user-id-display" class="text-xs sm:text-sm text-gray-500 bg-gray-200 px-3 py-1 rounded-full"></span>
                     <button id="logout-btn" class="px-3 sm:px-4 py-2 text-sm font-medium bg-orange-500 text-white rounded-md hover:bg-orange-600 focus:outline-none">Déconnexion</button>
                </div>
            </div>
        </header>

        <!-- Vue de Connexion -->
        <main id="login-view">
             <div class="max-w-md mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-center text-blue-800 mb-6">Identifiez-vous</h2>
                
                <!-- Section Itinérant -->
                <div class="space-y-2 border-b pb-4 mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">Accès Itinérant</h3>
                    <div>
                        <label for="itinerant-search" class="block text-sm font-medium text-gray-700">Recherchez votre nom</label>
                        <div class="relative mt-1">
                            <input type="text" id="itinerant-search" autocomplete="off" class="w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" placeholder="Commencez à taper votre nom...">
                            <div id="itinerant-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-48 overflow-y-auto view-hidden"></div>
                        </div>
                    </div>
                    <button id="login-itinerant-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-800 hover:bg-blue-900">
                        Accéder
                    </button>
                </div>
    
                <!-- Section Salarié -->
                <div class="space-y-2">
                    <h3 class="text-lg font-semibold text-gray-700">Accès Salarié</h3>
                    <div>
                        <label for="salarie-search" class="block text-sm font-medium text-gray-700">Recherchez votre nom</label>
                        <div class="relative mt-1">
                            <input type="text" id="salarie-search" autocomplete="off" class="w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md" placeholder="Commencez à taper votre nom...">
                            <div id="salarie-results" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md mt-1 max-h-48 overflow-y-auto view-hidden"></div>
                        </div>
                    </div>
                    <button id="login-salarie-btn" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-800 hover:bg-blue-900">
                        Accéder
                    </button>
                </div>
                
                <div class="mt-6 border-t pt-4">
                     <label for="admin-password" class="block text-sm font-medium text-gray-700">Accès Administrateur</label>
                     <input type="password" id="admin-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="Mot de passe">
                     <button id="login-admin-btn" class="mt-2 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-gray-600 hover:bg-gray-700">
                        Connexion Admin
                    </button>
                    <p id="admin-error" class="text-red-500 text-xs mt-1"></p>
                </div>
             </div>
        </main>

        <!-- Vue Itinérant Standard -->
        <main id="itinerant-view" class="view-hidden">
             <div class="mb-4 border-b border-gray-200">
                <nav id="itinerant-tabs" class="flex space-x-8" aria-label="Tabs">
                    <button class="admin-tab active" data-tab="itinerant-calendar">Mon Calendrier</button>
                    <button class="admin-tab" data-tab="itinerant-planning">Planification Annuelle</button>
                </nav>
            </div>
             <div id="itinerant-tab-content">
                <div id="tab-itinerant-calendar">
                    <div class="bg-white p-2 sm:p-6 rounded-lg shadow-md">
                        <div id="itinerant-calendar-header" class="flex justify-between items-center text-center mb-4">
                            <button id="itinerant-prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
                            <h2 class="text-xl sm:text-2xl font-semibold"></h2>
                            <button id="itinerant-next-month-btn" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
                        </div>
                        <div id="itinerant-calendar-container" class="overflow-x-auto"></div>
                    </div>
                </div>
                <div id="tab-itinerant-planning" class="view-hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-2">Planifier les Stages et Vacances</h3>
                        <p class="text-sm text-gray-600 mb-4">Cliquez sur une semaine pour définir son statut pour toute l'année.</p>
                        <div id="annual-planning-container" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Vue Itinérant Responsable -->
        <main id="responsable-view" class="view-hidden">
             <div class="mb-4 border-b border-gray-200">
                <nav id="responsable-tabs" class="flex space-x-8" aria-label="Tabs">
                    <button class="admin-tab active" data-tab="resp-calendar">Mon Calendrier</button>
                    <button class="admin-tab" data-tab="resp-suivi">Suivi Corporation</button>
                    <button class="admin-tab" data-tab="resp-planning">Planification Annuelle</button>
                </nav>
            </div>
            <div id="responsable-tab-content">
                <div id="tab-resp-calendar">
                     <div class="bg-white p-2 sm:p-6 rounded-lg shadow-md">
                        <div id="responsable-calendar-header" class="flex justify-between items-center text-center mb-4">
                            <button id="responsable-prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
                            <h2 class="text-xl sm:text-2xl font-semibold"></h2>
                            <button id="responsable-next-month-btn" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
                        </div>
                        <div id="responsable-calendar-container" class="overflow-x-auto"></div>
                    </div>
                </div>
                <div id="tab-resp-suivi" class="view-hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md overflow-x-auto">
                        <div class="mb-4">
                            <h3 class="text-xl font-semibold">Suivi de la corporation</h3>
                            <p id="responsable-suivi-label" class="text-gray-600 text-sm mt-1"></p>
                        </div>
                        <div id="responsable-suivi-container"></div>
                    </div>
                </div>
                 <div id="tab-resp-planning" class="view-hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold mb-2">Planifier les Stages et Vacances</h3>
                        <p class="text-sm text-gray-600 mb-4">Cliquez sur une semaine pour définir son statut pour toute l'année.</p>
                        <div id="annual-planning-container-resp" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Vue Salarié -->
        <main id="salarie-view" class="view-hidden">
            <div class="bg-white p-2 sm:p-6 rounded-lg shadow-md">
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <div id="salarie-meal-counter" class="text-center">
                        <p class="text-sm text-gray-600">Repas prévus ce mois-ci</p>
                        <p class="text-3xl font-bold text-blue-800">0</p>
                    </div>
                </div>
                <div id="salarie-rules-message" class="mb-4 p-4 bg-blue-50 border border-blue-200 text-blue-800 rounded-md text-sm">
                </div>
                <div id="salarie-calendar-header" class="flex justify-between items-center text-center mb-4">
                    <button id="salarie-prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>
                    <h2 class="text-xl sm:text-2xl font-semibold"></h2>
                    <button id="salarie-next-month-btn" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>
                </div>
                <div id="salarie-calendar-container" class="overflow-x-auto"></div>
            </div>
        </main>

        <!-- Vue Administrateur -->
        <main id="admin-view" class="view-hidden">
            <div class="relative w-full mb-4 border-b border-gray-200">
                <div class="overflow-x-auto pb-2">
                    <nav id="admin-tabs" class="flex space-x-4 sm:space-x-8 whitespace-nowrap" aria-label="Tabs">
                        <button class="admin-tab active py-2 px-1 text-sm sm:text-base" data-tab="dashboard">Tableau de Bord</button>
                        <button class="admin-tab py-2 px-1 text-sm sm:text-base" data-tab="reports">Rapports</button>
                        <button class="admin-tab py-2 px-1 text-sm sm:text-base" data-tab="users">Utilisateurs</button>
                        <button class="admin-tab py-2 px-1 text-sm sm:text-base" data-tab="suivi">Suivi Salariés</button>
                        <button class="admin-tab py-2 px-1 text-sm sm:text-base" data-tab="menus">Menus</button>
                    </nav>
                </div>
            </div>

            <div id="admin-tab-content">
                <!-- Tableau de Bord -->
                <div id="tab-dashboard">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                        <!-- Repas pour demain -->
                        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                            <h3 class="text-lg sm:text-xl font-semibold text-gray-800">Repas pour Demain</h3>
                            <p id="dashboard-tomorrow-date" class="text-sm text-gray-500 mb-4"></p>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">Déjeuners :</span>
                                    <span id="dashboard-lunch-count" class="text-2xl font-bold text-blue-800">...</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-medium">Dîners :</span>
                                    <span id="dashboard-dinner-count" class="text-2xl font-bold text-blue-800">...</span>
                                </div>
                            </div>
                        </div>
                        <!-- Suivi Salariés -->
                        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                            <h3 class="text-lg sm:text-xl font-semibold text-gray-800">Suivi Salariés</h3>
                            <p id="dashboard-suivi-week" class="text-sm text-gray-500 mb-4"></p>
                             <div class="flex justify-between items-center">
                                <span class="font-medium">Saisies incomplètes :</span>
                                <span id="dashboard-suivi-incomplete" class="text-2xl font-bold text-red-600">...</span>
                            </div>
                            <button id="dashboard-goto-suivi" class="mt-4 w-full text-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-800 hover:bg-blue-900">Voir le détail</button>
                        </div>
                        <!-- Raccourcis -->
                        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                            <h3 class="text-lg sm:text-xl font-semibold text-gray-800">Raccourcis</h3>
                            <div class="mt-4 space-y-3">
                                <button id="dashboard-goto-users" class="w-full text-left py-2 px-4 bg-gray-100 hover:bg-gray-200 rounded-md">Gérer les utilisateurs</button>
                                <button id="dashboard-goto-menus" class="w-full text-left py-2 px-4 bg-gray-100 hover:bg-gray-200 rounded-md">Gérer les menus</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rapports -->
                <div id="tab-reports" class="view-hidden">
                     <div class="flex justify-between items-center text-center mb-4 bg-white p-4 rounded-lg shadow"><button id="admin-prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">&lt;</button><h3 class="text-lg sm:text-xl font-semibold" id="admin-header-daily">Décompte journalier</h3><button id="admin-next-month-btn" class="p-2 rounded-full hover:bg-gray-200">&gt;</button></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md overflow-x-auto"><div id="admin-counts-container"></div></div>
                        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md overflow-x-auto"><div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4"><h3 class="text-lg sm:text-xl font-semibold">Décompte par Utilisateur</h3><button id="export-csv-btn" class="mt-2 sm:mt-0 px-4 py-2 text-sm font-medium bg-green-600 text-white rounded-md hover:bg-green-700">Exporter (CSV)</button></div><div id="admin-user-counts-container" class="max-h-96 overflow-y-auto"></div></div>
                    </div>
                </div>

                <!-- Gestion Utilisateurs -->
                <div id="tab-users" class="view-hidden">
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold mb-4">Créer un utilisateur</h3><form id="create-user-form" class="space-y-4"><div><label for="user-type" class="block text-sm font-medium text-gray-700">Type de profil</label><select id="user-type" required class="w-full p-2 border rounded mt-1"><option value="itinérant">Itinérant</option><option value="salarié">Salarié</option></select></div><div id="salarie-statut-container" class="view-hidden"><label for="salarie-statut" class="block text-sm font-medium text-gray-700">Statut du Salarié</label><select id="salarie-statut" class="w-full p-2 border rounded mt-1"><option value="standard">Standard</option><option value="commercial">Commercial</option></select></div><div id="itinerant-role-container"><label for="itinerant-role" class="block text-sm font-medium text-gray-700">Rôle Itinérant</label><select id="itinerant-role" class="w-full p-2 border rounded mt-1"><option value="standard">Standard</option><option value="responsable">Responsable</option></select></div><input type="text" id="user-nom" placeholder="Nom" required class="w-full p-2 border rounded"><input type="text" id="user-prenom" placeholder="Prénom" required class="w-full p-2 border rounded"><input type="email" id="user-email" placeholder="Email" required class="w-full p-2 border rounded"><input type="text" id="user-chambre" placeholder="N° de chambre" required class="w-full p-2 border rounded"><div><label id="metier-service-label" for="user-metier" class="block text-sm font-medium text-gray-700">Métier</label><select id="user-metier" required class="w-full p-2 border rounded mt-1"></select></div><div class="flex items-center"><input id="user-vegetarien" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"><label for="user-vegetarien" class="ml-2 block text-sm text-gray-900">Végétarien</label></div><button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-blue-800 hover:bg-blue-900">Créer</button><p id="user-create-feedback" class="text-green-600 text-sm"></p></form></div>
                        <div id="user-lists-wrapper" class="lg:col-span-2 space-y-8"><div class="bg-white p-4 sm:p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold mb-4">Liste des Itinérants</h3><div id="itinerant-list-container" class="overflow-x-auto"></div></div><div class="bg-white p-4 sm:p-6 rounded-lg shadow-md"><h3 class="text-xl font-semibold mb-4">Liste des Salariés</h3><div id="salarie-list-container" class="overflow-x-auto"></div></div></div>
                     </div>
                </div>
                 
                <!-- Suivi Salariés -->
                <div id="tab-suivi" class="view-hidden">
                    <div class="bg-white p-4 sm:p-6 rounded-lg shadow-md overflow-x-auto"><div class="mb-4"><h3 class="text-xl font-semibold">Suivi de la saisie des salariés</h3><p id="suivi-week-label" class="text-gray-600 text-sm mt-1"></p></div><div id="suivi-container"></div></div>
                </div>

                <!-- Gestion Menus -->
                <div id="tab-menus" class="view-hidden">
                    <div class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md"><h2 class="text-2xl font-semibold mb-4">Ajouter / Modifier un menu</h2><form id="meal-form" class="space-y-4"><div><label for="day" class="block text-sm font-medium text-gray-700">Jour de la semaine</label><select id="day" name="day" class="mt-1 block w-full p-2 border-gray-300 rounded-md"><option>Lundi</option> <option>Mardi</option> <option>Mercredi</option> <option>Jeudi</option> <option>Vendredi</option> <option>Samedi</option> <option>Dimanche</option></select></div><div><label for="meal-type" class="block text-sm font-medium text-gray-700">Type de repas</label><select id="meal-type" name="meal-type" class="mt-1 block w-full p-2 border-gray-300 rounded-md"><option>Déjeuner</option><option>Dîner</option></select></div><div><label for="description" class="block text-sm font-medium text-gray-700">Description du repas</label><textarea id="description" name="description" rows="4" class="mt-1 w-full p-2 border border-gray-300 rounded-md" placeholder="Ex: Poulet rôti, frites..."></textarea></div><button type="submit" class="w-full py-2 px-4 rounded-md text-white bg-blue-800 hover:bg-blue-900">Enregistrer le menu</button><div id="save-feedback" class="text-center text-green-600 font-medium mt-2"></div></form></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, where, getDocs, addDoc, serverTimestamp, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBQrYxzDJiSaX6fAzFCHRsMjOmznXQ1KSo",
            authDomain: "gestion-repas-compagnons.firebaseapp.com",
            projectId: "gestion-repas-compagnons",
            storageBucket: "gestion-repas-compagnons.appspot.com",
            messagingSenderId: "74457969505",
            appId: "1:74457969505:web:edc6bbb1a0332ca9ddcb20",
            measurementId: "G-4KYNTJNL3T"
        };
        
        const ADMIN_PASSWORD = "admin";

        // --- Firebase ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentUserId = null;
        let selectedUserProfile = null;
        let allUsers = [];
        let allSchedules = [];
        let allMenus = {};
        let annualPlan = {};
        const daysOfWeek = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
        let currentDate = new Date();
        let unsubscribeUsersLoginListener = null;
        let selectedItinerantId = null;
        let selectedSalarieId = null;
        let isImpersonating = false;
        
        const itinerantMetiers = ['Carrossier', 'Charpentier', 'Chaudronnier', 'Couvreur', 'Ebéniste', 'Mécanicien', 'Menuisier', 'Métallier', 'Pâtissier', 'Peintre', 'Plombier', 'Tailleur de pierre', 'Tapissier', 'Maroquinier', 'Electricien', 'Boulanger'];
        const salarieServices = ['Développement', 'Administratif', 'Production', 'Financier'];

        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const itinerantView = document.getElementById('itinerant-view');
        const responsableView = document.getElementById('responsable-view');
        const salarieView = document.getElementById('salarie-view');
        const adminView = document.getElementById('admin-view');
        const headerControls = document.getElementById('header-controls');
        const itinerantSearchInput = document.getElementById('itinerant-search');
        const salarieSearchInput = document.getElementById('salarie-search');
        const itinerantResultsContainer = document.getElementById('itinerant-results');
        const salarieResultsContainer = document.getElementById('salarie-results');
        const itinerantCalendarContainer = document.getElementById('itinerant-calendar-container');
        const itinerantCalendarHeader = document.getElementById('itinerant-calendar-header').querySelector('h2');
        const responsableCalendarContainer = document.getElementById('responsable-calendar-container');
        const responsableCalendarHeader = document.getElementById('responsable-calendar-header').querySelector('h2');
        const salarieCalendarContainer = document.getElementById('salarie-calendar-container');
        const salarieCalendarHeader = document.getElementById('salarie-calendar-header').querySelector('h2');
        const adminHeaderDaily = document.getElementById('admin-header-daily');
        const itinerantListContainer = document.getElementById('itinerant-list-container');
        const salarieListContainer = document.getElementById('salarie-list-container');
        const userListsWrapper = document.getElementById('user-lists-wrapper');
        const adminCountsContainer = document.getElementById('admin-counts-container');
        const adminUserCountsContainer = document.getElementById('admin-user-counts-container');
        const suiviContainer = document.getElementById('suivi-container');
        const suiviWeekLabel = document.getElementById('suivi-week-label');
        
        // --- Collections Refs (Simplified Path) ---
        const getUsersCollection = () => collection(db, 'users');
        const getSchedulesCollection = () => collection(db, 'schedules');
        const getMenusCollection = () => collection(db, 'menus');
        const getAnnualPlanDoc = (userId) => doc(db, 'annual_plans', userId);
        
        // --- Date Management ---
        const getMonthData = (year, month) => {
            const monthName = new Date(year, month).toLocaleString('fr-FR', { month: 'long', year: 'numeric' });
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDayIndex = (new Date(year, month, 1).getDay() + 6) % 7; // Monday = 0
            return { monthName, daysInMonth, firstDayIndex };
        };

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
        }

        const getDeadline = (targetDate) => {
            const date = new Date(targetDate.getTime());
            date.setHours(0, 0, 0, 0);
            const dayOfWeek = date.getDay() === 0 ? 7 : date.getDay(); 
            const dateOfMonday = date.getDate() - dayOfWeek + 1;
            const mondayOfTargetWeek = new Date(date.setDate(dateOfMonday));
            const deadline = new Date(mondayOfTargetWeek);
            deadline.setDate(mondayOfTargetWeek.getDate() - 11);
            deadline.setHours(23, 59, 59, 999);
            return deadline;
        };

        const updateCurrentDate = (monthOffset) => {
            currentDate.setDate(1); 
            currentDate.setMonth(currentDate.getMonth() + monthOffset);
            if (selectedUserProfile) {
                 if (selectedUserProfile.role === 'responsable') {
                    initializeResponsableView();
                } else if (selectedUserProfile.type === 'salarié') {
                    initializeSalarieView();
                } else {
                    initializeItinerantView();
                }
            }
            if (!adminView.classList.contains('view-hidden')) {
                 initializeAdminView();
            }
        };

        // --- App Initialization ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                
                if (unsubscribeUsersLoginListener) unsubscribeUsersLoginListener();
                
                unsubscribeUsersLoginListener = onSnapshot(query(getUsersCollection()), (snapshot) => {
                    allUsers = [];
                    snapshot.forEach(doc => allUsers.push({ id: doc.id, ...doc.data() }));
                    
                    if(!adminView.classList.contains('view-hidden')) {
                        renderUserLists();
                        initializeDashboard();
                        initializeSuiviView();
                    }

                    const itinerants = allUsers.filter(u => u.type === 'itinérant' || !u.type);
                    const salaries = allUsers.filter(u => u.type === 'salarié');
                    
                    setupSearch(itinerantSearchInput, itinerantResultsContainer, itinerants, (userId) => { selectedItinerantId = userId; });
                    setupSearch(salarieSearchInput, salarieResultsContainer, salaries, (userId) => { selectedSalarieId = userId; });

                }, (error) => {
                    console.error("Firestore error on users collection:", error);
                });

                listenToMenus();
                
                if (!selectedUserProfile) showView('login');

            } else {
                signInAnonymously(auth).catch(err => {
                    console.error("Anonymous sign-in failed:", err);
                    if (err.code === 'auth/configuration-not-found') {
                        loginView.innerHTML = `<div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-md text-center"><h2 class="text-2xl font-bold text-red-600 mb-4">Erreur de Configuration Firebase</h2><p class="text-gray-700">La méthode de connexion "Anonyme" doit être activée.</p><p class="mt-4 text-gray-600 text-sm">Pour corriger cela :</p><ol class="text-left text-sm mt-2 list-decimal list-inside space-y-1 bg-gray-50 p-4 rounded-md"><li>Allez sur la <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 hover:underline">Console Firebase</a>.</li><li>Sélectionnez votre projet (<strong>${firebaseConfig.projectId}</strong>).</li><li>Allez à <strong>Build > Authentication</strong>, puis onglet <strong>Sign-in method</strong>.</li><li>Activez le fournisseur <strong>Anonyme</strong>.</li><li>Rechargez cette page.</li></ol></div>`;
                    }
                });
            }
        });

        const setupSearch = (inputElement, resultsContainer, userList, onSelectCallback) => {
            inputElement.addEventListener('input', () => {
                onSelectCallback(null);
                const searchTerm = inputElement.value.toLowerCase();
                if (searchTerm.length < 1) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.classList.add('view-hidden');
                    return;
                }
                const filteredUsers = userList.filter(user => `${user.prenom} ${user.nom}`.toLowerCase().includes(searchTerm));
                if (filteredUsers.length > 0) {
                    resultsContainer.innerHTML = filteredUsers.map(user => `<div class="p-2 cursor-pointer hover:bg-gray-100" data-id="${user.id}" data-name="${user.prenom} ${user.nom}">${user.prenom} ${user.nom}</div>`).join('');
                    resultsContainer.classList.remove('view-hidden');
                } else {
                    resultsContainer.innerHTML = '<div class="p-2 text-gray-500">Aucun utilisateur trouvé</div>';
                    resultsContainer.classList.remove('view-hidden');
                }
            });

            resultsContainer.addEventListener('click', (e) => {
                if (e.target && e.target.dataset.id) {
                    const userId = e.target.dataset.id;
                    const userName = e.target.dataset.name;
                    onSelectCallback(userId);
                    inputElement.value = userName;
                    resultsContainer.innerHTML = '';
                    resultsContainer.classList.add('view-hidden');
                }
            });

            document.addEventListener('click', (e) => {
                if (!resultsContainer.contains(e.target) && e.target !== inputElement) {
                     resultsContainer.classList.add('view-hidden');
                }
            });
        };

        const listenToMenus = () => {
             onSnapshot(query(getMenusCollection()), (snapshot) => {
                allMenus = {};
                snapshot.forEach(doc => { allMenus[doc.id] = doc.data(); });
                if (selectedUserProfile) {
                    if (selectedUserProfile.role === 'responsable') initializeResponsableView();
                    else if (selectedUserProfile.type === 'salarié') initializeSalarieView();
                    else initializeItinerantView();
                }
             });
        };
        
        const showView = (viewName) => {
            loginView.classList.add('view-hidden');
            itinerantView.classList.add('view-hidden');
            responsableView.classList.add('view-hidden');
            salarieView.classList.add('view-hidden');
            adminView.classList.add('view-hidden');
            headerControls.classList.add('view-hidden');

            if (viewName === 'login') loginView.classList.remove('view-hidden');
            else {
                if (viewName === 'itinerant') itinerantView.classList.remove('view-hidden');
                if (viewName === 'responsable') responsableView.classList.remove('view-hidden');
                if (viewName === 'salarie') salarieView.classList.remove('view-hidden');
                if (viewName === 'admin') adminView.classList.remove('view-hidden');
                headerControls.classList.remove('view-hidden');
            }
        };

        const logout = () => {
            if(isImpersonating){
                isImpersonating = false;
                selectedUserProfile = null;
                showView('admin');
                initializeAdminView();
            } else {
                selectedUserProfile = null;
                currentDate = new Date(); 
                document.getElementById('user-id-display').textContent = '';
                showView('login');
            }
        };

        // --- Itinerant Logic ---
        const initializeItinerantView = () => {
            if (!selectedUserProfile) return;
            document.getElementById('user-id-display').textContent = isImpersonating ? `Admin > ${selectedUserProfile.prenom}` : `Profil: ${selectedUserProfile.prenom} (Itinérant)`;
            document.getElementById('logout-btn').textContent = isImpersonating ? 'Retour Admin' : 'Déconnexion';
            
            const targetYear = currentDate.getFullYear();
            const targetMonth = currentDate.getMonth();
            const scheduleDocId = `${selectedUserProfile.id}-${targetYear}-${targetMonth}`;
            
            onSnapshot(doc(getSchedulesCollection(), scheduleDocId), (doc) => {
                const userSchedule = doc.exists() ? doc.data() : {};
                renderItinerantCalendar(userSchedule, itinerantCalendarContainer, itinerantCalendarHeader);
            });
             onSnapshot(doc(getAnnualPlanDoc(selectedUserProfile.id)), doc => {
                annualPlan = doc.exists() ? doc.data() : {};
                renderAnnualPlanning(document.getElementById('annual-planning-container'));
            });
        };
        
        const initializeResponsableView = () => {
             if (!selectedUserProfile) return;
            document.getElementById('user-id-display').textContent = `Profil: ${selectedUserProfile.prenom} (Responsable)`;
            
            // Calendar part
            const targetYear = currentDate.getFullYear();
            const targetMonth = currentDate.getMonth();
            const scheduleDocId = `${selectedUserProfile.id}-${targetYear}-${targetMonth}`;
            onSnapshot(doc(getSchedulesCollection(), scheduleDocId), (doc) => {
                const userSchedule = doc.exists() ? doc.data() : {};
                renderItinerantCalendar(userSchedule, responsableCalendarContainer, responsableCalendarHeader);
            });

             onSnapshot(doc(getAnnualPlanDoc(selectedUserProfile.id)), doc => {
                annualPlan = doc.exists() ? doc.data() : {};
                renderAnnualPlanning(document.getElementById('annual-planning-container-resp'));
            });

            // Suivi part
            initializeResponsableSuivi();
        };

        const initializeResponsableSuivi = async () => {
            document.getElementById('responsable-suivi-label').textContent = `Mois de ${currentDate.toLocaleString('fr-FR', {month: 'long', year: 'numeric'})}`;
            const metier = selectedUserProfile.metier;
            const itinerantsInMetier = allUsers.filter(u => u.metier === metier && (u.type === 'itinérant' || !u.type));

            let html = `<table class="w-full text-xs sm:text-sm"><thead><tr class="bg-gray-50"><th class="p-1 sm:p-2 border text-left">Nom</th><th class="p-1 sm:p-2 border text-center">Statut</th></tr></thead><tbody>`;

            for (const itinerant of itinerantsInMetier) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const scheduleDoc = await getDoc(doc(getSchedulesCollection(), `${itinerant.id}-${year}-${month}`));
                const scheduleData = scheduleDoc.exists() ? scheduleDoc.data() : {};

                const annualPlanDoc = await getDoc(doc(getAnnualPlanDoc(itinerant.id)));
                const userAnnualPlan = annualPlanDoc.exists() ? annualPlanDoc.data() : {};
                
                let isComplete = true;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(year, month, day);
                    const weekNum = getWeekNumber(date);

                    if (!scheduleData[day] && !userAnnualPlan[weekNum]) {
                        isComplete = false;
                        break;
                    }
                }

                const statusIcon = isComplete 
                    ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">✓ Complété</span>`
                    : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">✗ Incomplet</span>`;

                 html += `<tr><td class="p-1 sm:p-2 border">${itinerant.prenom} ${itinerant.nom}</td><td class="p-1 sm:p-2 border text-center">${statusIcon}</td></tr>`;
            }
             html += `</tbody></table>`;
             document.getElementById('responsable-suivi-container').innerHTML = html;
        };


        const renderItinerantCalendar = (schedule = {}, container, header) => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const { monthName, daysInMonth, firstDayIndex } = getMonthData(year, month);
            header.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);

            let html = `<table class="calendar-table"><thead><tr>`;
            daysOfWeek.forEach(day => html += `<th>${day.substring(0,3)}</th>`);
            html += `</tr></thead><tbody><tr>`;
            for (let i = 0; i < firstDayIndex; i++) html += `<td class="other-month"></td>`;

            for (let day = 1; day <= daysInMonth; day++) {
                if (day > 1 && (firstDayIndex + day - 1) % 7 === 0) html += `</tr><tr>`;
                
                const dayDate = new Date(year, month, day);
                const weekNum = getWeekNumber(dayDate);
                const dayOfWeekName = daysOfWeek[dayDate.getDay() === 0 ? 6 : dayDate.getDay() - 1];
                let menuHtml = '';
                const menuDejeuner = allMenus[`${dayOfWeekName}-Déjeuner`]?.description;
                const menuDiner = allMenus[`${dayOfWeekName}-Dîner`]?.description;
                if(menuDejeuner) menuHtml += `<p><b>M:</b> ${menuDejeuner}</p>`;
                if(menuDiner) menuHtml += `<p><b>S:</b> ${menuDiner}</p>`;

                let daySchedule = schedule[day] || {};
                
                const annualWeekPlan = annualPlan[weekNum];
                if ((!daySchedule.midi || daySchedule.midi === '-') && annualWeekPlan) {
                    daySchedule.midi = annualWeekPlan.status === 'stage' ? 'S' : 'V';
                }
                if ((!daySchedule.soir || daySchedule.soir === '-') && annualWeekPlan) {
                    daySchedule.soir = annualWeekPlan.status === 'stage' ? 'S' : 'V';
                }

                const midiStatus = daySchedule.midi || '-';
                const soirStatus = daySchedule.soir || '-';

                html += `<td class="h-36 sm:h-40 p-1 sm:p-2">
                    <div class="calendar-day-number">${day}</div>
                    <div class="text-xs text-gray-500 mt-1 space-y-1">${menuHtml}</div>
                    <div class="mt-2 space-y-1 text-xs">
                         <div class="flex items-center"><span class="w-10">Midi:</span><button data-day="${day}" data-meal="midi" data-status="1" class="meal-choice-btn p-1 border rounded ${midiStatus === '1' || midiStatus === 'S' ? 'selected' : ''}">1</button><button data-day="${day}" data-meal="midi" data-status="0" class="meal-choice-btn p-1 border rounded ml-1 ${midiStatus === '0' || midiStatus === 'V' ? 'selected' : ''}">0</button></div>
                         <div class="flex items-center"><span class="w-10">Soir:</span><button data-day="${day}" data-meal="soir" data-status="1" class="meal-choice-btn p-1 border rounded ${soirStatus === '1' || soirStatus === 'S' ? 'selected' : ''}">1</button><button data-day="${day}" data-meal="soir" data-status="0" class="meal-choice-btn p-1 border rounded ml-1 ${soirStatus === '0' || soirStatus === 'V' ? 'selected' : ''}">0</button></div>
                         <div class="border-t pt-1 mt-1 flex space-x-1"><button data-day="${day}" data-type="stage" class="day-action-btn flex-1 p-1 border rounded bg-blue-100 hover:bg-blue-200">Stage</button><button data-day="${day}" data-type="vacances" class="day-action-btn flex-1 p-1 border rounded bg-yellow-100 hover:bg-yellow-200">Vacance</button></div>
                    </div>
                </td>`;
            }
            html += `</tr></tbody></table>`;
            container.innerHTML = html;
        };

        const renderAnnualPlanning = (container) => {
             const year = new Date().getFullYear();
            let html = `<h4 class="text-lg font-semibold mb-4 text-center">${year}</h4>`;
            
            for(let month=0; month<12; month++){
                html += `<div class="mb-4"><p class="font-semibold text-gray-800">${new Date(year, month).toLocaleString('fr-FR', {month: 'long'})}</p><div class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-2 mt-2">`;
                
                const firstDayOfMonth = new Date(year, month, 1);
                const firstMonday = new Date(firstDayOfMonth);
                firstMonday.setDate(firstDayOfMonth.getDate() - (firstDayOfMonth.getDay() + 6) % 7);
                
                for(let i=0; i<6; i++){
                    const mondayOfWeek = new Date(firstMonday);
                    mondayOfWeek.setDate(firstMonday.getDate() + i * 7);

                    if(mondayOfWeek.getFullYear() > year || mondayOfWeek.getMonth() > month) break;

                    const sundayOfWeek = new Date(mondayOfWeek);
                    sundayOfWeek.setDate(mondayOfWeek.getDate() + 6);
                    
                    const weekNum = getWeekNumber(mondayOfWeek);
                    const weekPlan = annualPlan[weekNum] || {status: 'none'};

                    html += `<div class="border rounded-lg p-2 text-sm">
                        <p class="font-medium">Sem. ${weekNum}</p>
                        <p class="text-xs text-gray-500">${mondayOfWeek.getDate()} - ${sundayOfWeek.getDate()} ${sundayOfWeek.toLocaleString('fr-FR', {month: 'short'})}</p>
                        <div class="mt-2 space-x-1"><button data-week="${weekNum}" data-status="stage" class="week-status-btn px-2 py-1 text-xs rounded ${weekPlan.status === 'stage' ? 'bg-blue-500 text-white' : 'bg-blue-100'}">S</button><button data-week="${weekNum}" data-status="vacances" class="week-status-btn px-2 py-1 text-xs rounded ${weekPlan.status === 'vacances' ? 'bg-yellow-400 text-white' : 'bg-yellow-100'}">V</button><button data-week="${weekNum}" data-status="none" class="week-status-btn px-2 py-1 text-xs rounded ${weekPlan.status === 'none' ? 'bg-gray-400 text-white' : 'bg-gray-200'}">X</button></div>
                        ${weekPlan.status === 'stage' ? `<input type="text" data-week="${weekNum}" class="location-input mt-2 w-full text-xs p-1 border rounded" placeholder="Lieu..." value="${weekPlan.location || ''}">` : ''}
                    </div>`;
                }

                html += `</div></div>`;
            }
            container.innerHTML = html;
        };

        const handleAnnualPlanClick = async (e) => {
            const target = e.target;
            if(!target.matches('.week-status-btn')) return;
            const week = target.dataset.week;
            const status = target.dataset.status;

            const planDocRef = getAnnualPlanDoc(selectedUserProfile.id);
            const newPlan = {...annualPlan};
            if(status === 'none') {
                delete newPlan[week];
            } else {
                newPlan[week] = { status, location: newPlan[week]?.location || '' };
            }

            try {
                await setDoc(planDocRef, newPlan);
            } catch (error) {
                console.error("Error updating annual plan", error);
            }
        };
        
        const handleLocationBlur = async (e) => {
            const target = e.target;
            if(!target.matches('.location-input')) return;

            const week = target.dataset.week;
            const location = target.value;
            
            const planDocRef = getAnnualPlanDoc(selectedUserProfile.id);
            const newPlan = {...annualPlan};
            if(newPlan[week]) {
                newPlan[week].location = location;
                 try {
                    await setDoc(planDocRef, newPlan);
                } catch (error) {
                    console.error("Error updating annual plan location", error);
                }
            }
        };

        document.getElementById('annual-planning-container').addEventListener('click', handleAnnualPlanClick);
        document.getElementById('annual-planning-container-resp').addEventListener('click', handleAnnualPlanClick);
        document.getElementById('annual-planning-container').addEventListener('blur', handleLocationBlur, true);
        document.getElementById('annual-planning-container-resp').addEventListener('blur', handleLocationBlur, true);
        
        // --- Salarié Logic ---
        const initializeSalarieView = () => {
             if (!selectedUserProfile) return;
            document.getElementById('user-id-display').textContent = isImpersonating ? `Admin > ${selectedUserProfile.prenom}` : `Profil: ${selectedUserProfile.prenom} (Salarié)`;
             document.getElementById('logout-btn').textContent = isImpersonating ? 'Retour Admin' : 'Déconnexion';
            
            const targetYear = currentDate.getFullYear();
            const targetMonth = currentDate.getMonth();
            const scheduleDocId = `${selectedUserProfile.id}-${targetYear}-${targetMonth}`;
            
            onSnapshot(doc(getSchedulesCollection(), scheduleDocId), (doc) => {
                const userSchedule = doc.exists() ? doc.data() : {};
                renderSalarieCalendar(userSchedule);
                updateSalarieMealCounter(userSchedule);
            });
        };

        const renderSalarieCalendar = (schedule = {}) => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const { monthName, daysInMonth, firstDayIndex } = getMonthData(year, month);
            salarieCalendarHeader.textContent = monthName.charAt(0).toUpperCase() + monthName.slice(1);
            
            const salarieRulesMessage = document.getElementById('salarie-rules-message');
            if(selectedUserProfile.statut === 'commercial') {
                salarieRulesMessage.innerHTML = `<p>En tant que commercial, vous pouvez modifier votre présence pour le mois en cours (jours futurs uniquement).</p>`;
            } else {
                salarieRulesMessage.innerHTML = `<p>Vous pouvez modifier votre présence pour une semaine jusqu'au <strong>jeudi de l'avant-dernière semaine</strong>. Ex: la semaine du 20 au 24 est modifiable jusqu'au jeudi 9 au soir. Les jours verrouillés sont grisés.</p>`;
            }


            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let html = `<table class="calendar-table"><thead><tr>`;
            daysOfWeek.forEach(day => html += `<th>${day.substring(0,3)}</th>`);
            html += `</tr></thead><tbody><tr>`;
            for (let i = 0; i < firstDayIndex; i++) html += `<td class="other-month"></td>`;

            for (let day = 1; day <= daysInMonth; day++) {
                if (day > 1 && (firstDayIndex + day - 1) % 7 === 0) html += `</tr><tr>`;
                
                const cellDate = new Date(year, month, day);
                const dayOfWeek = cellDate.getDay();
                const isWeekend = (dayOfWeek === 6 || dayOfWeek === 0);

                if (isWeekend) {
                    html += `<td class="h-28 sm:h-32 p-1 sm:p-2 other-month"><div class="calendar-day-number">${day}</div></td>`;
                    continue;
                }
                
                let isLocked = false;
                if (!isImpersonating) { // Admins can always edit
                    if (selectedUserProfile.statut === 'commercial') {
                        const realCurrentDate = new Date();
                        if (cellDate < today || cellDate.getMonth() !== realCurrentDate.getMonth() || cellDate.getFullYear() !== realCurrentDate.getFullYear()) {
                            isLocked = true;
                        }
                    } else {
                        const deadline = getDeadline(cellDate);
                        const windowStart = new Date(deadline.getTime());
                        windowStart.setDate(windowStart.getDate() - 6);
                        windowStart.setHours(0, 0, 0, 0);
                        isLocked = !(today >= windowStart && today <= deadline);
                    }
                }
                
                const lockedClass = isLocked ? 'day-locked' : '';
                const daySchedule = schedule[day] || {};
                const midiStatus = daySchedule.midi || '-';

                html += `<td class="h-28 sm:h-32 p-1 sm:p-2 ${lockedClass}">
                    <div class="calendar-day-number">${day}</div>
                    <div class="mt-2 text-center">
                        <p class="text-sm mb-2">Déjeuner</p>
                        <div class="flex justify-center space-x-2">
                           <button data-day="${day}" data-meal="midi" data-status="1" class="meal-choice-btn p-2 w-12 border rounded ${midiStatus === '1' ? 'selected' : ''}">Oui</button>
                           <button data-day="${day}" data-meal="midi" data-status="0" class="meal-choice-btn p-2 w-12 border rounded ${midiStatus === '0' ? 'selected' : ''}">Non</button>
                        </div>
                    </div>
                </td>`;
            }
            html += `</tr></tbody></table>`;
            salarieCalendarContainer.innerHTML = html;
        };

        const updateSalarieMealCounter = (schedule = {}) => {
            let count = 0;
            for(const day in schedule) {
                if(!isNaN(day)) {
                    if(schedule[day] && schedule[day].midi === '1') {
                        count++;
                    }
                }
            }
            document.querySelector('#salarie-meal-counter p:last-child').textContent = count;
        };

        // --- Admin Logic ---
        const initializeAdminView = () => {
            document.getElementById('user-id-display').textContent = 'Mode Administrateur';
             document.getElementById('logout-btn').textContent = 'Déconnexion';
            const targetYear = currentDate.getFullYear();
            const targetMonth = currentDate.getMonth();
            const schedulesQuery = query(getSchedulesCollection(), where("month", "==", targetMonth), where("year", "==", targetYear));
            
            onSnapshot(schedulesQuery, (snapshot) => {
                 allSchedules = [];
                 snapshot.forEach(doc => allSchedules.push({ id: doc.id, ...doc.data() }));
                 renderAdminReports();
                 initializeDashboard();
                 initializeSuiviView();
            });

             renderUserLists();
        };

        const renderAdminReports = () => {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const { monthName, daysInMonth } = getMonthData(year, month);
            adminHeaderDaily.textContent = `Décompte pour ${monthName}`;
            
            const dailyCounts = {};
            for(let day=1; day<=daysInMonth; day++) { dailyCounts[day] = { midi: 0, soir: 0 }; }

            allSchedules.forEach(schedule => {
                const user = allUsers.find(u => u.id === schedule.userId);
                if (!user) return;
                
                for(let day=1; day<=daysInMonth; day++) {
                    const daySchedule = schedule[day];
                    if (daySchedule) {
                        if (daySchedule.midi === '1' || daySchedule.midi === 'S') dailyCounts[day].midi++;
                        if (daySchedule.soir === '1' || daySchedule.soir === 'S') dailyCounts[day].soir++;
                    }
                }
            });

            let dailyHtml = `<table class="w-full text-xs sm:text-sm"><thead><tr class="bg-gray-50"><th class="p-1 sm:p-2 border">Jour</th><th class="p-1 sm:p-2 border">Déjeuner</th><th class="p-1 sm:p-2 border">Dîner</th></tr></thead><tbody>`;
            for(let day=1; day<=daysInMonth; day++) {
                dailyHtml += `<tr><td class="p-1 sm:p-2 border font-bold">${day}</td><td class="p-1 sm:p-2 border text-center text-blue-800 font-bold">${dailyCounts[day].midi}</td><td class="p-1 sm:p-2 border text-center text-blue-800 font-bold">${dailyCounts[day].soir}</td></tr>`;
            }
            dailyHtml += `</tbody></table>`;
            adminCountsContainer.innerHTML = dailyHtml;

            let userHtml = `<table class="w-full text-xs sm:text-sm"><thead><tr class="bg-gray-50"><th class="p-1 sm:p-2 border text-left">Nom</th><th class="p-1 sm:p-2 border text-left">Type</th><th class="p-1 sm:p-2 border">Midi</th><th class="p-1 sm:p-2 border">Soir</th></tr></thead><tbody>`;
            allUsers.sort((a,b) => a.nom.localeCompare(b.nom)).forEach(user => {
                const userSchedule = allSchedules.find(s => s.userId === user.id);
                const veggieIcon = user.vegetarien ? ' 🌿' : '';
                let midiCount = 0;
                let soirCount = 0;
                if(userSchedule) {
                    for(let day=1; day<=daysInMonth; day++) {
                        const daySchedule = userSchedule[day];
                        if (daySchedule) {
                             if (daySchedule.midi === '1' || daySchedule.midi === 'S') midiCount++;
                             if ((user.type === 'itinérant' || !user.type) && (daySchedule.soir === '1' || daySchedule.soir === 'S')) soirCount++;
                        }
                    }
                }
                userHtml += `<tr><td class="p-1 sm:p-2 border">${user.prenom} ${user.nom}${veggieIcon}</td><td class="p-1 sm:p-2 border">${user.type}</td><td class="p-1 sm:p-2 border text-center font-bold">${midiCount}</td><td class="p-1 sm:p-2 border text-center font-bold">${soirCount}</td></tr>`;
            });
            userHtml += `</tbody></table>`;
            adminUserCountsContainer.innerHTML = userHtml;
        };
        
        const renderUserLists = () => {
             const itinerants = allUsers.filter(u => u.type === 'itinérant' || !u.type);
             const salaries = allUsers.filter(u => u.type === 'salarié');

             itinerantListContainer.innerHTML = generateUserTable(itinerants);
             salarieListContainer.innerHTML = generateUserTable(salaries);
        };
        
        const generateUserTable = (userList) => {
            let html = `<table class="w-full text-xs sm:text-sm"><thead><tr class="bg-gray-50"><th class="p-1 sm:p-2 border text-left">Nom</th><th class="p-1 sm:p-2 border text-left">Type</th><th class="p-1 sm:p-2 border text-left">Métier/Service</th><th class="p-1 sm:p-2 border">Actions</th></tr></thead><tbody>`;
             userList.sort((a,b) => a.nom.localeCompare(b.nom)).forEach(user => {
                const veggieIcon = user.vegetarien ? ' 🌿' : '';
                const typeDisplay = user.type === 'salarié' ? `Salarié ${user.statut === 'commercial' ? '(Com.)' : ''}` : `Itinérant ${user.role === 'responsable' ? '(Resp.)' : ''}`;
                 html += `<tr data-user-row-id="${user.id}"><td class="p-1 sm:p-2 border">${user.prenom} ${user.nom}${veggieIcon}</td><td class="p-1 sm:p-2 border">${typeDisplay}</td><td class="p-1 sm:p-2 border">${user.metier}</td><td class="p-1 sm:p-2 border text-center"><button data-id="${user.id}" class="manage-schedule-btn text-purple-600 hover:text-purple-800">Planning</button><button data-id="${user.id}" class="edit-user-btn text-blue-600 hover:text-blue-800 ml-2">Modifier</button><button data-id="${user.id}" class="delete-user-btn text-red-600 hover:text-red-800 ml-2">Suppr.</button></td></tr>`;
             });
             html += `</tbody></table>`;
             return html;
        }

        const initializeDashboard = async () => {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('dashboard-tomorrow-date').textContent = tomorrow.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });

            let lunchCount = 0;
            let dinnerCount = 0;
            const year = tomorrow.getFullYear();
            const month = tomorrow.getMonth();
            const day = tomorrow.getDate();

            for(const user of allUsers) {
                const scheduleDocId = `${user.id}-${year}-${month}`;
                const scheduleDoc = await getDoc(doc(getSchedulesCollection(), scheduleDocId));
                if(scheduleDoc.exists()){
                    const scheduleData = scheduleDoc.data();
                    const daySchedule = scheduleData[day];
                    if (daySchedule) {
                        if (daySchedule.midi === '1' || daySchedule.midi === 'S') lunchCount++;
                        if ((user.type === 'itinérant' || !user.type) && (daySchedule.soir === '1' || daySchedule.soir === 'S')) dinnerCount++;
                    }
                }
            }
            document.getElementById('dashboard-lunch-count').textContent = lunchCount;
            document.getElementById('dashboard-dinner-count').textContent = dinnerCount;
        }

        const initializeSuiviView = async () => {
            const today = new Date();
            today.setHours(0,0,0,0);
            
            const thisMonday = new Date(today);
            thisMonday.setDate(today.getDate() - (today.getDay() + 6) % 7);
            
            let monitoredWeekMonday;
            const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon, ..., 6=Sat
            if (dayOfWeek >= 5) { 
                 monitoredWeekMonday = new Date(thisMonday.setDate(thisMonday.getDate() + 21));
            } else { 
                 monitoredWeekMonday = new Date(thisMonday.setDate(thisMonday.getDate() + 14));
            }
            
            const monitoredWeekDays = [];
            for(let i=0; i<5; i++) {
                const day = new Date(monitoredWeekMonday);
                day.setDate(monitoredWeekMonday.getDate() + i);
                monitoredWeekDays.push(day);
            }
            
            const start = monitoredWeekDays[0];
            const end = monitoredWeekDays[4];
            const weekLabel = `Semaine du ${start.toLocaleDateString('fr-FR')} au ${end.toLocaleDateString('fr-FR')}`;
            suiviWeekLabel.textContent = weekLabel;
            document.getElementById('dashboard-suivi-week').textContent = weekLabel;
            
            const salaries = allUsers.filter(u => u.type === 'salarié');
            if (salaries.length === 0) {
                suiviContainer.innerHTML = `<p class="text-gray-500">Aucun salarié à suivre.</p>`;
                document.getElementById('dashboard-suivi-incomplete').textContent = "0";
                return;
            }

            let html = `<table class="w-full text-xs sm:text-sm"><thead><tr class="bg-gray-50"><th class="p-1 sm:p-2 border text-left">Nom</th><th class="p-1 sm:p-2 border text-center">Statut</th></tr></thead><tbody>`;
            let incompleteCount = 0;
            
            for (const salarie of salaries) {
                let isComplete = true;
                for (const day of monitoredWeekDays) {
                    const year = day.getFullYear();
                    const month = day.getMonth();
                    const dayOfMonth = day.getDate();
                    const scheduleDocId = `${salarie.id}-${year}-${month}`;
                    const scheduleDoc = await getDoc(doc(getSchedulesCollection(), scheduleDocId));
                    const scheduleData = scheduleDoc.exists() ? scheduleDoc.data() : {};
                    if (!scheduleData[dayOfMonth] || scheduleData[dayOfMonth].midi === '-') {
                        isComplete = false;
                        break;
                    }
                }
                
                if (!isComplete) incompleteCount++;

                const statusIcon = isComplete 
                    ? `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">✓ Complété</span>`
                    : `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">✗ Incomplet</span>`;
                
                html += `<tr><td class="p-1 sm:p-2 border">${salarie.prenom} ${salarie.nom}</td><td class="p-1 sm:p-2 border text-center">${statusIcon}</td></tr>`;
            }
            html += `</tbody></table>`;
            suiviContainer.innerHTML = html;
            document.getElementById('dashboard-suivi-incomplete').textContent = incompleteCount;
        };
        
        const exportToCSV = () => {
             const year = currentDate.getFullYear();
             const month = currentDate.getMonth();
             let csvContent = "data:text/csv;charset=utf-8,";
             csvContent += "Prénom,Nom,Type,Rôle/Statut,Métier/Service,Chambre/Bureau,Régime Spécial,Total Midi,Total Soir\r\n";

            allUsers.forEach(user => {
                const userSchedule = allSchedules.find(s => s.userId === user.id);
                let midiCount = 0;
                let soirCount = 0;
                if(userSchedule) {
                     for(const day in userSchedule) {
                        if(!isNaN(day)) {
                            const daySchedule = userSchedule[day];
                            if(daySchedule) {
                                if (daySchedule.midi === '1' || daySchedule.midi === 'S') midiCount++;
                                if (daySchedule.soir === '1' || daySchedule.soir === 'S') soirCount++;
                            }
                        }
                    }
                }
                const specialDiet = user.vegetarien ? "Végétarien" : "";
                const roleStatus = user.type === 'salarié' ? user.statut : user.role;
                csvContent += `${user.prenom},${user.nom},${user.type || 'itinérant'},${roleStatus || 'standard'},${user.metier},${user.chambre},${specialDiet},${midiCount},${soirCount}\r\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `decompte_repas_${year}_${month+1}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
        
        const loginUser = (userId) => {
            if (userId) {
                selectedUserProfile = allUsers.find(u => u.id === userId);
                if (selectedUserProfile) {
                    const userType = selectedUserProfile.type || 'itinérant';
                    if (selectedUserProfile.role === 'responsable') {
                        currentDate = new Date();
                        showView('responsable');
                        initializeResponsableView();
                    } else if (userType === 'salarié') {
                        if (selectedUserProfile.statut === 'commercial') {
                            currentDate = new Date();
                        } else {
                             const today = new Date();
                            today.setHours(0,0,0,0);
                            const thisMonday = new Date(today);
                            thisMonday.setDate(today.getDate() - (today.getDay() + 6) % 7);
                            let monitoredWeekMonday;
                            const dayOfWeek = today.getDay();
                            if (dayOfWeek >= 5) { 
                                 monitoredWeekMonday = new Date(thisMonday.setDate(thisMonday.getDate() + 21));
                            } else { 
                                 monitoredWeekMonday = new Date(thisMonday.setDate(thisMonday.getDate() + 14));
                            }
                            currentDate = monitoredWeekMonday;
                        }
                        showView('salarie');
                        initializeSalarieView();
                    } else {
                        currentDate = new Date();
                        showView('itinerant');
                        initializeItinerantView();
                    }
                }
            }
        };

        const switchTab = (tabName) => {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.admin-tab[data-tab="${tabName}"]`).classList.add('active');
            document.querySelectorAll('#admin-tab-content > div').forEach(c => c.classList.add('view-hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('view-hidden');
        };

        // --- Event Listeners ---
        document.getElementById('login-itinerant-btn').addEventListener('click', () => loginUser(selectedItinerantId));
        document.getElementById('login-salarie-btn').addEventListener('click', () => loginUser(selectedSalarieId));

        document.getElementById('login-admin-btn').addEventListener('click', () => {
             if (document.getElementById('admin-password').value === ADMIN_PASSWORD) {
                document.getElementById('admin-error').textContent = '';
                document.getElementById('admin-password').value = '';
                currentDate = new Date();
                showView('admin');
                initializeAdminView();
            } else {
                document.getElementById('admin-error').textContent = 'Mot de passe incorrect.';
            }
        });

        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('export-csv-btn').addEventListener('click', exportToCSV);

        const userTypeSelect = document.getElementById('user-type');
        const userMetierSelect = document.getElementById('user-metier');
        const userChambreInput = document.getElementById('user-chambre');
        const metierServiceLabel = document.getElementById('metier-service-label');
        const salarieStatutContainer = document.getElementById('salarie-statut-container');
        const itinerantRoleContainer = document.getElementById('itinerant-role-container');

        const updateUserCreationForm = () => {
            const type = userTypeSelect.value;
            userMetierSelect.innerHTML = '';
            if (type === 'salarié') {
                metierServiceLabel.textContent = 'Service';
                userChambreInput.placeholder = "Bureau";
                populateMetierSelect(salarieServices, "Choisir un service");
                salarieStatutContainer.classList.remove('view-hidden');
                itinerantRoleContainer.classList.add('view-hidden');
            } else {
                metierServiceLabel.textContent = 'Métier';
                userChambreInput.placeholder = "N° de chambre";
                populateMetierSelect(itinerantMetiers, "Choisir un métier");
                salarieStatutContainer.classList.add('view-hidden');
                 itinerantRoleContainer.classList.remove('view-hidden');
            }
        };
        
        const populateMetierSelect = (options, placeholder) => {
            userMetierSelect.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
            options.forEach(opt => {
                const optionEl = document.createElement('option');
                optionEl.value = opt;
                optionEl.textContent = opt;
                userMetierSelect.appendChild(optionEl);
            });
        };
        
        userTypeSelect.addEventListener('change', updateUserCreationForm);
        updateUserCreationForm();

        document.getElementById('create-user-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const newUser = {
                nom: form['user-nom'].value, prenom: form['user-prenom'].value,
                email: form['user-email'].value, chambre: form['user-chambre'].value,
                metier: form['user-metier'].value, type: form['user-type'].value,
                vegetarien: form['user-vegetarien'].checked,
                createdAt: serverTimestamp()
            };
            if(newUser.type === 'salarié') {
                newUser.statut = form['salarie-statut'].value;
            } else {
                newUser.role = form['itinerant-role'].value;
            }

            try {
                await addDoc(getUsersCollection(), newUser);
                document.getElementById('user-create-feedback').textContent = 'Utilisateur créé !';
                form.reset();
                updateUserCreationForm();
                setTimeout(() => document.getElementById('user-create-feedback').textContent = '', 3000);
            } catch (err) { console.error(err); }
        });

        document.getElementById('itinerant-prev-month-btn').addEventListener('click', () => updateCurrentDate(-1));
        document.getElementById('itinerant-next-month-btn').addEventListener('click', () => updateCurrentDate(1));
        document.getElementById('responsable-prev-month-btn').addEventListener('click', () => updateCurrentDate(-1));
        document.getElementById('responsable-next-month-btn').addEventListener('click', () => updateCurrentDate(1));
        document.getElementById('salarie-prev-month-btn').addEventListener('click', () => updateCurrentDate(-1));
        document.getElementById('salarie-next-month-btn').addEventListener('click', () => updateCurrentDate(1));
        document.getElementById('admin-prev-month-btn').addEventListener('click', () => updateCurrentDate(-1));
        document.getElementById('admin-next-month-btn').addEventListener('click', () => updateCurrentDate(1));
        
        const handleCalendarClick = async (e, container) => {
            const target = e.target;
            const day = target.dataset.day;
            if (!day || !selectedUserProfile) return;
            
            const targetYear = currentDate.getFullYear();
            const targetMonth = currentDate.getMonth();
            const scheduleDocRef = doc(getSchedulesCollection(), `${selectedUserProfile.id}-${targetYear}-${targetMonth}`);
            let currentDayValues = {};
            const scheduleDoc = await getDoc(scheduleDocRef).catch(() => null);
            if (scheduleDoc && scheduleDoc.exists() && scheduleDoc.data()[day]) {
                currentDayValues = scheduleDoc.data()[day];
            }

            const updateSchedule = (values) => {
                 setDoc(scheduleDocRef, { 
                    [day]: values,
                    userId: selectedUserProfile.id,
                    year: targetYear,
                    month: targetMonth
                 }, { merge: true }).catch(console.error);
            };

            if (target.classList.contains('meal-choice-btn')) {
                currentDayValues[target.dataset.meal] = target.dataset.status;
                updateSchedule(currentDayValues);
            }
            if (target.classList.contains('day-action-btn')) {
                updateSchedule({ midi: target.dataset.type === 'stage' ? 'S' : 'V', soir: target.dataset.type === 'stage' ? 'S' : 'V' });
            }
        };

        itinerantCalendarContainer.addEventListener('click', (e) => handleCalendarClick(e, itinerantCalendarContainer));
        responsableCalendarContainer.addEventListener('click', (e) => handleCalendarClick(e, responsableCalendarContainer));

        salarieCalendarContainer.addEventListener('click', async (e) => {
             const target = e.target;
             const day = target.dataset.day;
            if (!day || !selectedUserProfile || target.closest('.day-locked')) return;

            const targetYear = currentDate.getFullYear();
            const targetMonth = currentDate.getMonth();
            const scheduleDocRef = doc(getSchedulesCollection(), `${selectedUserProfile.id}-${targetYear}-${targetMonth}`);
           
            if (target.classList.contains('meal-choice-btn')) {
                const newStatus = target.dataset.status;
                 setDoc(scheduleDocRef, { 
                    [day]: { midi: newStatus },
                    userId: selectedUserProfile.id,
                    year: targetYear,
                    month: targetMonth
                 }, { merge: true }).catch(console.error);
            }
        });

        userListsWrapper.addEventListener('click', async (e) => {
            const target = e.target;
            const row = target.closest('tr');
            if (!row) return;

            if (target.classList.contains('manage-schedule-btn')) {
                const userId = target.dataset.id;
                isImpersonating = true;
                loginUser(userId);
                return;
            }

            if (target.classList.contains('delete-user-btn')) {
                const userId = target.dataset.id;
                if (!target.classList.contains('confirm-delete')) {
                    document.querySelectorAll('.confirm-delete').forEach(btn => {
                        btn.textContent = 'Suppr.';
                        btn.classList.remove('confirm-delete', 'bg-red-500', 'text-white', 'rounded', 'px-2', 'py-1');
                    });
                    target.textContent = 'Confirmer ?';
                    target.classList.add('confirm-delete', 'bg-red-500', 'text-white', 'rounded', 'px-2', 'py-1');
                    setTimeout(() => {
                        if (target && target.classList.contains('confirm-delete')) {
                            target.textContent = 'Suppr.';
                            target.classList.remove('confirm-delete', 'bg-red-500', 'text-white', 'rounded', 'px-2', 'py-1');
                        }
                    }, 3000);
                } else {
                    try {
                        await deleteDoc(doc(getUsersCollection(), userId));
                    } catch (error) { console.error("Error deleting user:", error); }
                }
                return;
            }
            
            if (target.classList.contains('cancel-edit-btn')) {
                renderUserLists();
                return;
            }
            
            if (target.classList.contains('save-edit-btn')) {
                const userId = target.dataset.id;
                const currentRow = document.querySelector(`tr[data-user-row-id="${userId}"]`);
                if(!currentRow) return;

                try {
                    const updatedData = {
                        nom: currentRow.querySelector('.edit-nom-input').value,
                        prenom: currentRow.querySelector('.edit-prenom-input').value,
                        chambre: currentRow.querySelector('.edit-chambre-input').value,
                        metier: currentRow.querySelector('.edit-metier-select').value,
                        type: currentRow.querySelector('.edit-type-select').value,
                        vegetarien: currentRow.querySelector('.edit-vegetarien-checkbox').checked,
                        statut: currentRow.querySelector('.edit-statut-select') ? currentRow.querySelector('.edit-statut-select').value : 'standard',
                        role: currentRow.querySelector('.edit-role-select') ? currentRow.querySelector('.edit-role-select').value : 'standard'
                    };
                    await updateDoc(doc(getUsersCollection(), userId), updatedData);
                } catch (error) { console.error("Error updating user:", error); }
                return;
            }

            if (target.classList.contains('edit-user-btn')) {
                const userId = target.dataset.id;
                const userToEdit = allUsers.find(u => u.id === userId);
                if (!userToEdit) return;
                renderUserLists();
                const rowToEdit = document.querySelector(`tr[data-user-row-id="${userId}"]`);
                if (!rowToEdit) return;

                const userType = userToEdit.type || 'itinérant';
                const options = userType === 'salarié' ? salarieServices : itinerantMetiers;
                const metierSelect = options.map(m => `<option value="${m}" ${userToEdit.metier === m ? 'selected' : ''}>${m}</option>`).join('');
                
                const typeOptions = ['itinérant', 'salarié'];
                const typeSelect = typeOptions.map(t => `<option value="${t}" ${userType === t ? 'selected' : ''}>${t}</option>`).join('');
                
                const veggieChecked = userToEdit.vegetarien ? 'checked' : '';
                
                let statutSelect = '';
                if(userType === 'salarié') {
                    const statutOptions = ['standard', 'commercial'];
                    statutSelect = `<select class="w-full p-1 border rounded mt-1 edit-statut-select">${statutOptions.map(s => `<option value="${s}" ${userToEdit.statut === s ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`).join('')}</select>`;
                }

                let roleSelect = '';
                 if(userType === 'itinérant') {
                    const roleOptions = ['standard', 'responsable'];
                    roleSelect = `<select class="w-full p-1 border rounded mt-1 edit-role-select">${roleOptions.map(s => `<option value="${s}" ${userToEdit.role === s ? 'selected' : ''}>${s.charAt(0).toUpperCase() + s.slice(1)}</option>`).join('')}</select>`;
                }

                rowToEdit.innerHTML = `
                    <td class="p-1 sm:p-2 border">
                        <input class="w-full p-1 border rounded edit-prenom-input" value="${userToEdit.prenom}">
                        <input class="w-full p-1 border rounded mt-1 edit-nom-input" value="${userToEdit.nom}">
                    </td>
                    <td class="p-1 sm:p-2 border">
                        <select class="w-full p-1 border rounded edit-type-select">${typeSelect}</select>
                        ${statutSelect}
                        ${roleSelect}
                        <div class="flex items-center mt-1">
                           <input type="checkbox" ${veggieChecked} class="h-4 w-4 text-blue-600 border-gray-300 rounded edit-vegetarien-checkbox">
                           <label class="ml-2 text-xs">Végétarien</label>
                        </div>
                    </td>
                    <td class="p-1 sm:p-2 border"><select class="w-full p-1 border rounded edit-metier-select">${metierSelect}</select></td>
                    <td class="p-1 sm:p-2 border text-center align-middle"><button data-id="${userId}" class="save-edit-btn text-green-600 hover:text-green-800 font-bold">OK</button><button class="cancel-edit-btn text-gray-600 hover:text-gray-800 ml-2">X</button></td>
                `;
            }
        });


        document.getElementById('admin-tabs').addEventListener('click', (e) => {
            if (e.target.matches('.admin-tab')) {
                switchTab(e.target.dataset.tab);
            }
        });

         document.getElementById('responsable-tabs').addEventListener('click', (e) => {
            if (e.target.matches('.admin-tab')) {
                const tab = e.target.dataset.tab;
                document.querySelectorAll('#responsable-tabs .admin-tab').forEach(t => t.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('#responsable-tab-content > div').forEach(c => c.classList.add('view-hidden'));
                document.getElementById(`tab-${tab}`).classList.remove('view-hidden');
            }
        });
        
        document.getElementById('dashboard-goto-suivi').addEventListener('click', () => switchTab('suivi'));
        document.getElementById('dashboard-goto-users').addEventListener('click', () => switchTab('users'));
        document.getElementById('dashboard-goto-menus').addEventListener('click', () => switchTab('menus'));
        
        document.getElementById('meal-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const mealId = `${form.day.value}-${form['meal-type'].value}`;
            try {
                await setDoc(doc(getMenusCollection(), mealId), { 
                    day: form.day.value, 
                    mealType: form['meal-type'].value, 
                    description: form.description.value 
                });
                document.getElementById('save-feedback').textContent = 'Menu enregistré !';
                form.description.value = '';
                setTimeout(() => document.getElementById('save-feedback').textContent = '', 2000);
            } catch (error) { console.error("Error saving meal: ", error); }
        });
        
    </script>
</body>
</html>

