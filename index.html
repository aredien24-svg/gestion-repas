<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des utilisateurs</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .user-item { display: flex; justify-content: space-between; margin: 5px 0; }
        .modal.view-hidden { display: none; }
        .modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fff; padding: 20px; border: 1px solid #ccc;
            z-index: 1000;
        }
        .modal h3 { margin-top: 0; }
        .modal input { display: block; width: 100%; margin: 5px 0; padding: 5px; }
        .modal button { margin: 5px; }
    </style>
</head>
<body>

    <h1>Gestion des utilisateurs</h1>
    <div id="user-list"></div>

    <!-- MODALE EDITION -->
    <div id="edit-user-modal" class="modal view-hidden">
        <h3>Modifier un utilisateur</h3>
        <form id="edit-user-form">
            <input type="hidden" id="edit-user-id">
            <input type="text" id="edit-user-nom" placeholder="Nom" required>
            <input type="text" id="edit-user-prenom" placeholder="Prénom" required>
            <input type="email" id="edit-user-email" placeholder="Email" required>
            <input type="text" id="edit-user-chambre" placeholder="Chambre" required>
            <input type="text" id="edit-user-metier" placeholder="Métier" required>
            <button type="submit">Enregistrer</button>
            <button type="button" id="cancel-edit-btn">Annuler</button>
        </form>
    </div>

    <!-- MODALE SUPPRESSION -->
    <div id="delete-confirm-modal" class="modal view-hidden">
        <h3>Supprimer un utilisateur</h3>
        <p>Êtes-vous sûr de vouloir supprimer cet utilisateur ?</p>
        <button id="confirm-delete-btn">Supprimer</button>
        <button id="cancel-delete-btn">Annuler</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // Config Firebase
        const firebaseConfig = {
            apiKey: "TON_API_KEY",
            authDomain: "TON_PROJET.firebaseapp.com",
            projectId: "TON_PROJET",
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Références DOM
        const userList = document.getElementById('user-list');
        const editUserModal = document.getElementById('edit-user-modal');
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const editUserForm = document.getElementById('edit-user-form');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        let userIdToDelete = null;

        // Affichage / masquage modales
        const showModal = (modal) => {
            [editUserModal, deleteConfirmModal].forEach(m => m.classList.add('view-hidden'));
            modal.classList.remove('view-hidden');
        };
        const closeModal = () => {
            [editUserModal, deleteConfirmModal].forEach(m => m.classList.add('view-hidden'));
        };

        cancelEditBtn.addEventListener('click', closeModal);
        cancelDeleteBtn.addEventListener('click', closeModal);

        // Ouvrir modale édition
        function openEditUser(user) {
            document.getElementById('edit-user-id').value = user.id;
            document.getElementById('edit-user-nom').value = user.nom;
            document.getElementById('edit-user-prenom').value = user.prenom;
            document.getElementById('edit-user-email').value = user.email;
            document.getElementById('edit-user-chambre').value = user.chambre;
            document.getElementById('edit-user-metier').value = user.metier;
            showModal(editUserModal);
        }

        // Ouvrir modale suppression
        function openDeleteUser(userId) {
            userIdToDelete = userId;
            showModal(deleteConfirmModal);
        }

        // Formulaire édition
        editUserForm.onsubmit = async (e) => {
            e.preventDefault();
            const userId = document.getElementById('edit-user-id').value;
            const userRef = doc(db, "users", userId);
            await updateDoc(userRef, {
                nom: document.getElementById('edit-user-nom').value,
                prenom: document.getElementById('edit-user-prenom').value,
                email: document.getElementById('edit-user-email').value,
                chambre: document.getElementById('edit-user-chambre').value,
                metier: document.getElementById('edit-user-metier').value,
            });
            closeModal();
            renderUserList();
        };

        // Suppression utilisateur
        confirmDeleteBtn.addEventListener('click', async () => {
            if (userIdToDelete) {
                await deleteDoc(doc(db, "users", userIdToDelete));
                userIdToDelete = null;
                closeModal();
                renderUserList();
            }
        });

        // Affichage liste utilisateurs
        async function renderUserList() {
            userList.innerHTML = "";
            const querySnapshot = await getDocs(collection(db, "users"));
            querySnapshot.forEach((docSnap) => {
                const user = { id: docSnap.id, ...docSnap.data() };
                const div = document.createElement('div');
                div.className = "user-item";
                div.innerHTML = `
                    <span>${user.nom} ${user.prenom} - ${user.email} - Chambre: ${user.chambre} - Métier: ${user.metier}</span>
                    <span>
                        <button class="edit-btn">Modifier</button>
                        <button class="delete-btn">Supprimer</button>
                    </span>
                `;
                div.querySelector('.edit-btn').addEventListener('click', () => openEditUser(user));
                div.querySelector('.delete-btn').addEventListener('click', () => openDeleteUser(user.id));
                userList.appendChild(div);
            });
        }

        // Initialisation
        renderUserList();
    </script>

</body>
</html>
